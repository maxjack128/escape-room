<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>黑白之間：密室逃脫 - 最終真相</title>
    <style>
        :root { --debug-color: rgba(255, 0, 0, 0); }
        
        body, html { 
            margin: 0; padding: 0; height: 100%; width: 100%;
            background: #222; display: flex; align-items: center; justify-content: center; overflow: hidden;
            font-family: "Noto Sans TC", sans-serif;
        }

        #game-container {
            position: relative;
            width: clamp(320px, 95vw, 1200px); 
            aspect-ratio: 16 / 9; 
            background: #000;
            box-shadow: 0 0 50px #000;
            overflow: hidden;
        }

        #room-view { width: 100%; height: 100%; background: url('room_main.png') no-repeat center/contain; position: relative; }

        /* Hotspots */
        .hotspot { position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: pointer; background: var(--debug-color); z-index: 5; }
        .hs-map { clip-path: polygon(10% 22%, 15% 22%, 20% 25%, 24% 34%, 24% 45%, 27% 55%, 22% 61%, 17% 61%, 13% 54%, 8% 59%, 6% 48%, 2% 39%, 5% 29%); }
        .hs-safe { clip-path: polygon(29% 59%, 37% 59%, 37% 71%, 29% 71%, 27% 70%, 27% 59%); }
        .hs-dumbbells { clip-path: polygon(17% 73%, 20% 75%, 20% 78%, 20% 81%, 19% 82%, 19% 84%, 20% 86%, 20% 90%, 18% 91%, 17% 92%, 16% 94%, 14% 94%, 13% 97%, 12% 99%, 10% 99%, 8% 96%, 9% 92%, 11% 90%, 12% 90%, 13% 87%, 15% 85%, 17% 83%, 16% 81%, 15% 79%, 15% 75%); }
        .hs-desk { clip-path: polygon(69% 68%, 76% 64%, 87% 67%, 86% 85%, 85% 87%, 84% 78%, 81% 80%, 81% 92%, 80% 93%, 78% 92%, 78% 81%, 77% 85%, 75% 86%, 74% 79%, 72% 79%, 72% 88%, 71% 90%, 69% 88%, 69% 78%); }
        .hs-clock { clip-path: polygon(83% 21%, 87% 22%, 88% 26%, 88% 35%, 86% 39%, 82% 37%, 81% 32%, 81% 24%); }
        .hs-poster { clip-path: polygon(56% 29%, 72% 29%, 72% 48%, 56% 48%); }
        .hs-floor { clip-path: polygon(39% 69%, 63% 69%, 68% 95%, 33% 95%); z-index: 2; }
        .hs-door { clip-path: polygon(44% 29%, 56% 29%, 56% 68%, 44% 68%); }
        .hs-lamp { clip-path: polygon(49% 0%, 49% 9%, 48% 11%, 47% 13%, 46% 17%, 46% 20%, 50% 21%, 54% 20%, 54% 17%, 53% 13%, 51% 11%, 51% 8%, 51% 0%); }
        .hs-card01 { clip-path: polygon(19% 83%, 21% 84%, 21% 88%, 19% 87%); z-index: 10; }
        .hs-card02 { clip-path: polygon(81% 67%, 83% 68%, 82% 72%, 80% 71%); z-index: 10; }
        .hs-card03 { clip-path: polygon(78% 80%, 77% 85%, 76% 84%, 76% 80%); z-index: 10; }
        .hs-card04 { clip-path: polygon(51% 9%, 50% 12%, 52% 14%, 53% 11%); z-index: 10; }

        /* Overlay & Zooms */
        #overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: #D3D3D3; display: none; flex-direction: column; 
            align-items: center; justify-content: center; z-index: 100; 
            padding: 10px; box-sizing: border-box;
        }

        .zoom-wrapper { 
            display: flex; align-items: center; justify-content: center; 
            gap: clamp(10px, 2vw, 40px); 
            max-width: 95%; max-height: 90%; 
            margin-top: 2vh;
        }
        
        .vertical-text {
            writing-mode: vertical-rl; text-orientation: mixed;
            font-size: clamp(12px, 1.5vw, 24px); letter-spacing: 0.2em;
            color: #333; border-left: 2px solid #888;
            padding-left: 1vw; align-self: center;
            text-align: start; line-height: 1.5; font-weight: 500;
            white-space: nowrap;
        }

        .back-arrow { 
            color: #8B7500; font-size: clamp(30px, 5vw, 50px); 
            cursor: pointer; margin-top: 5px; 
            transition: transform 0.2s; display: inline-block; 
        }
        .back-arrow:hover { transform: scale(1.2); }

        /* 一般放大圖樣式 */
        .zoom-img { 
            max-height: 55vh; 
            width: auto; max-width: 70vw; 
            display: block; object-fit: contain; 
        }

        /* 卡片專屬白底座樣式 */
        .card-base {
            background-color: #FFFFFF;
            padding: clamp(10px, 2vw, 25px);
            box-sizing: border-box;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            /* 固定長寬比為 3:4，您可以根據需要修改為 1:1 或 2:3 */
            aspect-ratio: 3 / 4; 
            width: auto;
            height: 55vh; /* 跟隨電腦版高度設定 */
        }
        .card-base img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* 手機版縮放優化 */
        @media (max-width: 600px) {
            .zoom-img { max-height: 45vh; }
            .card-base { height: 40vh; } /* 手機版底座縮小一點確保空間 */
            .vertical-text { padding-left: 5px; letter-spacing: 0.1em; }
        }

        /* Inventory */
        #inventory { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; background: rgba(0,0,0,0.5); padding: 8px; border-radius: 10px; z-index: 20; }
        .slot {width: 7vw; height: 7vw; max-width: 60px; max-height: 60px; border: 1px dashed #666; background-size: contain; background-repeat: no-repeat; background-position: center; cursor: pointer; }
        .slot.active { border: 1px solid #fff; background-color: rgba(255,255,255,0.1); }

        /* ...其餘動畫與特殊畫面樣式維持不變... */
        #final-stage { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(90deg, #FFF 50%, #000 50%); z-index: 999; display: none; }
        .final-img { position: absolute; width: 15vw; transition: all 4s cubic-bezier(0.4, 0, 0.2, 1); opacity: 0; }
        #final-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #888; font-size: clamp(1.2rem, 4vw, 2.5rem); letter-spacing: clamp(0.3rem, 2vw, 1rem); opacity: 0; transition: opacity 2s; z-index: 10; text-align: center; width: 90%; text-shadow: 2px 2px 4px rgba(0,0,0,0.3), -2px -2px 4px rgba(255,255,255,0.3); }
        #blackout-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; opacity: 0; pointer-events: none; transition: opacity 3s; z-index: 2000; display: flex; align-items: center; justify-content: center; }
        #ending-quotes { position: absolute; bottom: 15vh; width: 100%; color: #aaa; font-size: clamp(1.2rem, 3vw, 2rem); letter-spacing: 0.2em; text-align: center; line-height: 2; opacity: 0; transition: opacity 1.5s, bottom 2s; z-index: 2001; }
        #second-puzzle-container { display: none; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%; z-index: 3000; }
        #puzzle-title { color: white; font-size: clamp(1.8rem, 4vw, 3rem); margin-bottom: 40px; font-weight: bold; opacity: 0; transition: opacity 2s; text-align: center; }
        #puzzle-input-wrapper { opacity: 0; transition: opacity 2s; text-align: center; }
        #puzzle-input { background: transparent; border: none; border-bottom: 3px solid white; color: white; font-size: 1.8rem; text-align: center; width: 300px; outline: none; padding: 10px; margin-bottom: 20px; }
        #puzzle-error { color: #ff4d4d; font-size: 1.2rem; font-weight: bold; height: 30px; visibility: hidden; }
        #illusion-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; align-items: center; justify-content: space-around; z-index: 4000; opacity: 0; transition: opacity 2s; background-color: black; }
        #illusion-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -1; }
        .illusion-text { font-size: clamp(1.5rem, 4vw, 3rem); font-weight: 900; opacity: 0; transition: opacity 1.5s; z-index: 4001; text-shadow: 0 0 10px rgba(128,128,128,0.5); letter-spacing: 0.1em; }
        #text-white { color: white; margin-top: 25vh; }
        #text-black { color: black; margin-bottom: 25vh; }
        #task-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 5000; display: none; flex-direction: column; align-items: center; justify-content: center; color: white; text-align: center; padding: 20px; box-sizing: border-box; }
        .task-line { font-size: clamp(1rem, 2.5vw, 1.8rem); margin: 15px 0; opacity: 0; transition: opacity 1.5s; line-height: 1.6; }
        .task-title { font-size: clamp(2.5rem, 6vw, 5rem); font-weight: 900; margin-top: 30px; letter-spacing: 0.3em; }
        @keyframes bounce { 0%, 100% { transform: translateX(-50%) translateY(0); } 50% { transform: translateX(-50%) translateY(-20px); } }
    </style>
</head>
<body>

<div id="game-container">
    <div id="room-view">
        <div class="hotspot hs-map" onclick="showZoom('map')"></div>
        <div class="hotspot hs-safe" onclick="showZoom('safe')"></div>
        <div class="hotspot hs-dumbbells" onclick="showZoom('dumbbells')"></div>
        <div class="hotspot hs-desk" onclick="showZoom('desk')"></div>
        <div class="hotspot hs-clock" onclick="showZoom('clock')"></div>
        <div class="hotspot hs-poster" onclick="showZoom('poster')"></div>
        <div class="hotspot hs-floor" onclick="showZoom('floor')"></div>
        <div class="hotspot hs-door" onclick="showZoom('door')"></div>
        <div class="hotspot hs-lamp" onclick="showZoom('lamp')"></div>
        
        <div id="card01-hs" class="hotspot hs-card01" onclick="pickupCard('card_01')"></div>
        <div id="card02-hs" class="hotspot hs-card02" onclick="pickupCard('card_02')"></div>
        <div id="card03-hs" class="hotspot hs-card03" onclick="pickupCard('card_03')"></div>
        <div id="card04-hs" class="hotspot hs-card04" onclick="pickupCard('card_04')"></div>
    </div>

    <div id="inventory">
        <div class="slot" id="slot-card_01" onclick="viewItem('card_01')"></div>
        <div class="slot" id="slot-card_02" onclick="viewItem('card_02')"></div>
        <div class="slot" id="slot-card_03" onclick="viewItem('card_03')"></div>
        <div class="slot" id="slot-card_04" onclick="viewItem('card_04')"></div>
        <div class="slot" id="slot-eval" onclick="viewItem('eval')"></div>
    </div>

    <div id="overlay">
        <div id="zoom-content"></div>
    </div>
</div>

<div id="final-stage">
    <img src="truth.png" id="img-tl" class="final-img" style="top: 10%; left: 5%;">
    <img src="truth.png" id="img-br" class="final-img" style="bottom: 10%; right: 5%;">
    <div id="final-text">恭喜逃出密室!</div>
    <div id="next-arrow" style="position: absolute; bottom: 5%; right: 5%; font-size: clamp(40px, 6vw, 80px); color: #FFD700; cursor: pointer; opacity: 0; transition: opacity 2s; z-index: 1001; display: none;" onclick="triggerBlackout()">▶</div>
    <div id="blackout-screen">
        <div id="ending-quotes"></div>
        <div id="second-puzzle-container">
            <div id="puzzle-title">「黑」與「白」之間究竟藏了什麼？</div>
            <div id="puzzle-input-wrapper">
                <input type="text" id="puzzle-input" placeholder="在此輸入答案..." onkeydown="if(event.key==='Enter') checkSecondPuzzle()">
                <div id="puzzle-error">❌請重新思考再回答</div>
            </div>
        </div>
        <div id="illusion-container">
            <img src="same_color.png" id="illusion-bg">
            <div id="text-white" class="illusion-text">上面這張圖方格全是「白」</div>
            <div id="text-black" class="illusion-text">下面這張圖方格全是「黑」</div>
        </div>
    </div>
</div>

<div id="task-screen">
    <div id="task-1" class="task-line">1. 請問「某性質」是什麼？</div>
    <div id="task-2" class="task-line">2. 找到第一題的答案後，請自製類似效果的圖片</div>
    <div id="task-3" class="task-line">3. 將這兩題的答案寄到丁丁的信箱：<br>maxjack128@mail3.hwsh.tc.edu.tw</div>
    <div id="task-title" class="task-line task-title">黑白之間</div>
</div>

<script>
    let isGameCleared = false;
    let safeStatus = "closed"; 
    let safeInput = "";
    let currentEval = ""; 
    let collectedItems = [];

    const data = {
        map: { img: 'map_zoom.png', desc: '一幅世界地圖，<br>但形狀怎麼怪怪的...' },
        dumbbells: { img: 'dumbbells_zoom.png', desc: '兩個7kg啞鈴，<br>問問丁丁可以練哪吧' },
        poster: { img: 'poster_zoom.png', desc: 'Red Velvet Seulgi的海報，<br>丁丁很喜歡' },
        clock: { img: 'clock_zoom.png', desc: '停止的圓型時鐘，<br>上面寫了英文字母R' },
        floor: { img: 'floor_zoom.png', desc: '吊燈投影出的光芒<br>隱約像是一個鬼臉...' },
        desk: { img: 'desk_zoom.png', desc: '老舊的木桌，桌上放了盤黑白棋<br>還是應該叫「黑灰棋」呢哈哈<br>下一步灰棋會減去黑棋<br><br>在角落處某人用立可白寫了段話' },
        lamp: { img: 'pendant_lamp_zoom.png', desc: '老舊的吊燈<br>光線勉強能看清楚這個房間' },
        eval_dark: { img: 'eval_dark.png', desc: '【漆黑線索】<br>從這手勢看來我應該是答對了' },
        eval_light: { img: 'eval_light.png', desc: '【純白線索】<br>從這手勢看來我應該是答錯了' },
        card_01: { img: 'card_01.png', desc: '【卡片：一】<br>卡片上有3個圓相切' },
        card_02: { img: 'card_02.png', desc: '【卡片：二】<br>卡片上有4個圓相切' },
        card_03: { img: 'card_03.png', desc: '【卡片：三】<br>卡片上有6個圓相切' },
        card_04: { img: 'card_04.png', desc: '【卡片：四】<br>卡片上有13個圓相切' }
    };

    function showZoom(type) {
        const overlay = document.getElementById('overlay');
        const content = document.getElementById('zoom-content');
        overlay.style.display = 'flex';
        
        if (type === 'door') { 
            renderDoor(content); 
        } else if (type === 'safe') { 
            renderSafe(content); 
        } else {
            const item = data[type];
            // 判斷是否為卡片，若是則加上白色長方形底座
            const isCard = type.startsWith('card_');
            
            content.innerHTML = `
                <div class="zoom-wrapper">
                    <div style="display:flex; flex-direction:column; align-items:center;">
                        ${isCard ? 
                            `<div class="card-base"><img src="${item.img}"></div>` : 
                            `<img src="${item.img}" class="zoom-img">`
                        }
                        <div class="back-arrow" onclick="closeZoom()">▼</div>
                    </div>
                    <div class="vertical-text">${item.desc}</div>
                </div>`;
        }
    }

    // ...其餘 JavaScript 函式（renderSafe, safePress, renderDoor...）維持不變...
    function renderSafe(container) {
        if (safeStatus !== "closed") {
            const imgFile = (safeStatus === "right") ? "safe_open_right.png" : "safe_open_wrong.png";
            const evalType = (safeStatus === "right") ? "eval_dark" : "eval_light";
            container.innerHTML = `
                <div class="zoom-wrapper">
                    <div style="display: flex; flex-direction: column; align-items: center;">
                        <div style="position: relative; width: clamp(280px, 60vw, 800px); aspect-ratio: 16/9;">
                            <img src="${imgFile}" style="width: 100%; height: 100%; object-fit: contain; display: block; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
                            <div style="position: absolute; top: 73%; left: 55%; width: 23%; height: 18%; cursor: pointer; z-index: 10; clip-path: polygon(15% 0%, 60% 0%, 80% 90%, 20% 100%);" onclick="pickupEval('${evalType}')"></div>
                        </div>
                        <div class="back-arrow" onclick="closeZoom()">▼</div>
                    </div>
                    <div class="vertical-text">金庫被打開了<br>這是...我答對了嗎？</div>
                </div>`;
        } else {
            container.innerHTML = `
                <div class="zoom-wrapper">
                    <div style="display: flex; flex-direction: column; align-items: center;">
                        <div style="position: relative; width: clamp(280px, 60vw, 800px); aspect-ratio: 16/9; background: #000;">
                            <div id="safe-display" style="position: absolute; top: 9.5%; left: 48.5%; width: 40%; height: 16%; font-family: monospace; font-size: clamp(14px, 2vw, 32px); color: #0f0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; border-radius: 5px; z-index: 20; pointer-events: none;">${safeInput}</div>
                            <img src="safe_zoom.png" style="width: 100%; height: 100%; object-fit: contain; display: block;">
                            <div style="position:absolute; top:29.5%; left:48.4%; width:7.5%; height:13%; cursor:pointer;" onclick="safePress('1')"></div>
                            <div style="position:absolute; top:29.5%; left:59.5%; width:7.5%; height:13%; cursor:pointer;" onclick="safePress('2')"></div>
                            <div style="position:absolute; top:29.5%; left:70.6%; width:7.5%; height:13%; cursor:pointer;" onclick="safePress('3')"></div>
                            <div style="position:absolute; top:29.5%; left:81.5%; width:7.5%; height:13%; cursor:pointer;" onclick="safePress('π')"></div>
                            <div style="position:absolute; top:44.5%; left:48.4%; width:7.5%; height:13%; cursor:pointer;" onclick="safePress('4')"></div>
                            <div style="position:absolute; top:44.5%; left:59.5%; width:7.5%; height:13%; cursor:pointer;" onclick="safePress('5')"></div>
                            <div style="position:absolute; top:44.5%; left:70.6%; width:7.5%; height:13%; cursor:pointer;" onclick="safePress('6')"></div>
                            <div style="position:absolute; top:44.5%; left:81.5%; width:7.5%; height:13%; cursor:pointer;" onclick="safePress('R')"></div>
                            <div style="position:absolute; top:60%; left:48.4%; width:7.5%; height:13%; cursor:pointer;" onclick="safePress('7')"></div>
                            <div style="position:absolute; top:60%; left:59.5%; width:7.5%; height:13%; cursor:pointer;" onclick="safePress('8')"></div>
                            <div style="position:absolute; top:60%; left:70.6%; width:7.5%; height:13%; cursor:pointer;" onclick="safePress('9')"></div>
                            <div style="position:absolute; top:60%; left:81.5%; width:7.5%; height:13%; cursor:pointer;" onclick="safePress('^')"></div>
                            <div style="position:absolute; top:75%; left:48.4%; width:7.5%; height:13%; cursor:pointer;" onclick="safePress('0')"></div>
                            <div style="position:absolute; top:75%; left:59.5%; width:7.5%; height:13%; cursor:pointer;" onclick="safePress('清除')"></div>
                            <div style="position:absolute; top:74%; left:70%; width:19%; height:13%; cursor:pointer;" onclick="safePress('提交')"></div>
                        </div>
                        <div class="back-arrow" onclick="closeZoom()">▼</div>
                    </div>
                    <div class="vertical-text">上面寫只能輸入一次...<br>看來得好好思考了</div>
                </div>`;
        }
    }

    function safePress(k) {
        if (k === '清除') { safeInput = ""; } 
        else if (k === '提交') {
            if (safeInput === "") return;
            const isCorrect = safeInput.includes('π') && safeInput.includes('2') && safeInput.includes('R');
            safeStatus = isCorrect ? "right" : "wrong";
            renderSafe(document.getElementById('zoom-content'));
        } else {
            if (safeInput.length < 10) safeInput += k;
        }
        const display = document.getElementById('safe-display');
        if (display) display.innerText = safeInput;
    }

    function renderDoor(container) {
        document.getElementById('overlay').style.backgroundColor = "#000";
        container.innerHTML = `
            <div class="zoom-wrapper" style="width: 90%; max-width: none;">
                <div style="display: flex; flex-direction: column; align-items: center; flex-grow: 1;">
                    <h2 style="color:#fff; font-size: clamp(16px, 2.5vw, 36px); letter-spacing: 0.5em; margin-bottom: 20px;">感應鎖</h2>
                    <div style="display: flex; justify-content: center; width: 100%; gap: 3vw;">
                        <div style="border: 2px solid #fff; padding: 10px; width: 40%; text-align: center; border-radius: 10px;">
                            <div style="font-size: 14px; color: #fff; margin-bottom: 10px;">請放入純白線索</div>
                            <input type="file" id="white-input" style="color: #fff; width: 100%; font-size: 12px;" onchange="checkDoubleKey()">
                        </div>
                        <div style="border: 2px solid #444; padding: 10px; width: 40%; text-align: center; border-radius: 10px;">
                            <div style="font-size: 14px; color: #888; margin-bottom: 10px;">請放入漆黑線索</div>
                            <input type="file" id="black-input" style="color: #fff; width: 100%; font-size: 12px;" onchange="checkDoubleKey()">
                        </div>
                    </div>
                    <div class="back-arrow" onclick="resetOverlayColor(); closeZoom();">▼</div>
                </div>
                <div class="vertical-text" style="color: #888; border-left: 2px solid #444;">另一張線索？看來得跟其他人合作了</div>
            </div>`;
    }

    function checkDoubleKey() {
        const whiteFile = document.getElementById('white-input').files[0];
        const blackFile = document.getElementById('black-input').files[0];
        if (whiteFile && blackFile) {
            if (whiteFile.name.includes('eval_light') && blackFile.name.includes('eval_dark')) {
                isGameCleared = true;
                alert("【感應成功】系統辨識完成。門鎖已解除，請點擊返回。");
            } else { alert("【驗證失敗】線索位置錯誤或檔案不符，請重新確認。"); }
        }
    }

    function closeZoom() { 
        document.getElementById('overlay').style.display = 'none'; 
        if (isGameCleared) {
            const roomView = document.getElementById('room-view');
            roomView.style.background = "url('room_out.png') no-repeat center/contain";
            roomView.innerHTML = ""; 
            const exitArrow = document.createElement('div');
            exitArrow.innerHTML = "▲";
            exitArrow.style.cssText = "position: absolute; bottom: 10%; left: 50%; transform: translateX(-50%); font-size: clamp(40px, 6vw, 80px); color: #0000FF; cursor: pointer; z-index: 100; animation: bounce 2s infinite;";
            exitArrow.onclick = () => {
                alert("門開了!雖然一片黑但只能出去了");
                startFinalAnimation();
            };
            roomView.appendChild(exitArrow);
        }
    }

    function startFinalAnimation() {
        const stage = document.getElementById('final-stage');
        const imgTL = document.getElementById('img-tl');
        const imgBR = document.getElementById('img-br');
        const txt = document.getElementById('final-text');
        const nextBtn = document.getElementById('next-arrow');
        stage.style.display = 'block';
        setTimeout(() => {
            imgTL.style.opacity = "1"; imgBR.style.opacity = "1";
            setTimeout(() => {
                imgTL.style.left = "75%"; imgBR.style.right = "75%";
                setTimeout(() => {
                    txt.style.opacity = "1";
                    setTimeout(() => {
                        nextBtn.style.display = "block";
                        setTimeout(() => { nextBtn.style.opacity = "1"; }, 100);
                    }, 2000);
                }, 5000);
            }, 800);
        }, 100);
    }

    function triggerBlackout() {
        const blackout = document.getElementById('blackout-screen');
        const quoteContainer = document.getElementById('ending-quotes');
        blackout.style.pointerEvents = "auto";
        blackout.style.opacity = "1";
        const quotes = [
            { text: "終於逃出來了", delay: 5000 },
            { text: "雖然還拿著兩張奇怪的線索，但...", delay: 8500 },
            { text: "謎題應該到這就結束了吧？", delay: 12000 }
        ];
        quotes.forEach((q, index) => {
            setTimeout(() => {
                quoteContainer.style.opacity = 0;
                setTimeout(() => {
                    quoteContainer.innerText = q.text;
                    quoteContainer.style.opacity = 1;
                    if (index === quotes.length - 1) {
                        setTimeout(() => {
                            quoteContainer.style.opacity = 0;
                            setTimeout(showSecondPuzzle, 2000);
                        }, 3000);
                    }
                }, 500);
            }, q.delay);
        });
    }

    function showSecondPuzzle() {
        const puzzleContainer = document.getElementById('second-puzzle-container');
        const quoteContainer = document.getElementById('ending-quotes');
        puzzleContainer.style.display = 'flex';
        setTimeout(() => {
            document.getElementById('puzzle-title').style.opacity = 1;
            setTimeout(() => {
                document.getElementById('puzzle-input-wrapper').style.opacity = 1;
                document.getElementById('puzzle-input').focus();
                setTimeout(() => {
                    quoteContainer.innerText = "竟然還有下一題!!!";
                    quoteContainer.style.opacity = 1;
                    setTimeout(() => { quoteContainer.style.opacity = 0; }, 2000);
                }, 800);
            }, 1500);
        }, 100);
    }

    function checkSecondPuzzle() {
        const input = document.getElementById('puzzle-input').value.trim().toLowerCase();
        const error = document.getElementById('puzzle-error');
        const quoteContainer = document.getElementById('ending-quotes');
        if (input === '灰' || input === '灰色' || input === 'gray') {
            error.style.visibility = "hidden";
            document.getElementById('puzzle-title').style.opacity = 0;
            document.getElementById('puzzle-input-wrapper').style.opacity = 0;
            setTimeout(() => {
                quoteContainer.style.bottom = "45vh"; 
                quoteContainer.innerHTML = "黑、灰、白其實是同一種顏色，<br>但是「某性質」不同導致看到的顏色不一樣";
                quoteContainer.style.opacity = 1;
                setTimeout(() => {
                    quoteContainer.style.opacity = 0;
                    setTimeout(showIllusionEnding, 2000);
                }, 5000);
            }, 1000);
        } else { error.style.visibility = "visible"; }
    }

    function showIllusionEnding() {
        const illusion = document.getElementById('illusion-container');
        const textW = document.getElementById('text-white');
        const textB = document.getElementById('text-black');
        illusion.style.display = 'flex';
        setTimeout(() => {
            illusion.style.opacity = 1;
            setTimeout(() => {
                textW.style.opacity = 1;
                setTimeout(() => {
                    textB.style.opacity = 1;
                    setTimeout(() => {
                        illusion.style.opacity = 0;
                        setTimeout(showFinalTask, 2000);
                    }, 4500);
                }, 1500);
            }, 1000);
        }, 100);
    }

    function showFinalTask() {
        const taskScreen = document.getElementById('task-screen');
        taskScreen.style.display = 'flex';
        const ids = ['task-1', 'task-2', 'task-3', 'task-title'];
        ids.forEach((id, index) => {
            setTimeout(() => { document.getElementById(id).style.opacity = 1; }, index * 1500);
        });
    }

    function resetOverlayColor() { document.getElementById('overlay').style.backgroundColor = "#D3D3D3"; }
    
    function pickupCard(id) {
        if (collectedItems.includes(id)) return;
        collectedItems.push(id);
        const slot = document.getElementById('slot-' + id);
        slot.classList.add('active');
        slot.style.backgroundImage = `url('${id}.png')`;
        if (document.getElementById(id.replace('_','') + "-hs")) 
            document.getElementById(id.replace('_','') + "-hs").style.display = 'none';
        alert("獲得卡片！已收納至道具欄。");
    }

    function viewItem(id) {
        if (id === 'eval') { if (currentEval) showZoom(currentEval); }
        else if (collectedItems.includes(id)) { showZoom(id); }
    }

    function pickupEval(type) {
        currentEval = type;
        const imgUrl = data[type].img;
        const slot = document.getElementById('slot-eval');
        slot.classList.add('active');
        slot.style.backgroundImage = `url('${imgUrl}')`;
        alert("獲得線索！已收納至道具欄。將開啟新分頁，請右鍵另存圖片");
        window.open(imgUrl, '_blank');
    }
</script>
</body>
</html>

